<!DOCTYPE html>
<html>
    <head>
        <title>Markdown Preview</title>
    </head>
    <body>
    <h2>PowerShellでやること</h2>

<ol>
<li>指定したファイルを渡してテキストエディタを起動する</li>
<li>プレビュー表示用のブラウザ(Internet Explorer)を起動する</li>
<li>指定したファイルの変更を監視する</li>
<li>ファイルが変更(保存)されたらMarkdownで記述された内容をHTMLに変換してブラウザで表示する</li>
</ol>

<h2>スクリプト</h2>

<p><a href="https://gist.github.com/b17830375b620d1557a5.git">https://gist.github.com/b17830375b620d1557a5.git</a></p>

<h3>1. 指定したファイルを渡してテキストエディタを起動する。</h3>

<p>```ps1
function Start-Markdown
{
    Param(
        # Markdown テキストファイルのパス
        [string]$Path
    )</p>

<pre><code># 指定したファイルが無ければ作る
if(-not(Test-Path $Path))
{
    New-Item $Path -ItemType file -Force
}

# ファイルの拡張子に関連付けられたアプリケーション(エディタ)を開く
start $Path
</code></pre>

<p>}
```</p>

<h3>2. MarkdownテキストをHTMLに変換する</h3>

<p>Markdownパーサには<a href="http://code.google.com/p/markdownsharp/">MarkdownSharp</a>を使用します。  </p>

<p>以下からソースコード(Visual Studioのソリューション一式)をダウンロードします。
<a href="http://code.google.com/p/markdownsharp/downloads/list">http://code.google.com/p/markdownsharp/downloads/list</a>  </p>

<p>ソリューションにはテストプロジェクトその他が含まれていますが、
<code>MarkdownSharp</code> 内の <code>Markdown.cs</code> 1ファイルにMarkdownSharpの全コード記述されています。<br />
今回は、このソースファイル(<code>Markdown.cs</code>)をPowerShellに直接読み込ませて使用します。</p>

<ul>
<li>MarkdownSharp
<ul>
<li>Markdown.cs</li>
</ul></li>
<li>MarkdownSharpTest</li>
<li>MarkdownSharp.sln</li>
</ul>

<p>```ps1
$html=
@'
<!DOCTYPE html>
<html>
    <head>
        <title>Markdown Preview</title>
    </head>
    <body>
    {0}
    </body>
</html>
'@</p>

<p>$previewPath = "$scriptDir..\Html\MarkdownPreview.html"</p>

<p>Add-Type -Path "$scriptDir..\CSharp\Markdown.cs" `
    - ReferencedAssemblies System.Configuration</p>

<p>$markdown = New-Object MarkdownSharp.Markdown</p>

<p>$rawText = Get-Content $Path -raw
$html -f $markdown.Transform($rawText) | Out-File $previewPath -Encoding utf8
```</p>

<h3>3. Internet Explorerを起動してPreview表示する</h3>

<p>```ps1
$ie = New-Object -ComObject InternetExplorer.Application</p>

<p>$ie.StatusBar = $false
$ie.AddressBar = $false
$ie.MenuBar = $false
$ie.ToolBar = $false</p>

<p>$ie.Navigate($previewPath)
$ie.Visible = $true</p>

<p>```</p>

<h3>4. Markdownテキストファイルが更新(保存)されたらプレビューも更新する</h3>

<p>```ps1
 # Markdownテキストファイルの変更を監視する File Watcherを生成
    $watcher = New-Object System.IO.FileSystemWatcher
    $watcher.Path = $sourceDir
    $watcher.Filter = Split-Path $Path -Leaf
    $watcher.NotifyFilter = [System.IO.NotifyFilters]::FileName -bor [System.IO.NotifyFilters]::LastWrite</p>

<h1>ファイルが変更されるのを監視し、変更されたらMarkdownテキストをHTMLに変換してInternet Explorerでプレビューする</h1>

<p>while($ie.ReadyState -ne $null)
{
    $result = $watcher.WaitForChanged([System.IO.WatcherChangeTypes]::Changed, 5000)
    if(-not $result.TimedOut)
    {
        $rawText = Get-Content $Path -raw
        $html -f $StyleSheet, $markdown.Transform($rawText) | Out-File $previewPath -Encoding utf8
        $ie.Refresh()
    }
    Start-Sleep -Milliseconds 100
}
```
aaaaa<br />
bbbb<br />
cccc</p>

    </body>
</html>
